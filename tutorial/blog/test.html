<!DOCTYPE html>
<html>
<title>Apakoh Core Tutorial</title>

<xmp theme="united" style="display:none;">
# Creating a blog

## Prerequisites

- A web server
- PHP 5.2
- PHP extensions: `mysql`, `mysqli`, `pdo_mysql`, `sqlite3`, or `pdo_sqlite`
- Apakoh Core

## Creating an application

Create an empty directory called `app` (or anything else really). This is your
app-directory.
Create a new PHP-file in your app-dir called `app.php` (again, other names are
fine). This file will contain the distribution-configuration, i.e. the name of
the application, version, and which modules to load. A basic configuration looks
like this:

    <?php
    // app/app.php
    return array(
      'path' => str_replace('\\', '/', dirname(__FILE__)),
      'name' => 'My Web Application',
      'version' => '0.0.1',
      'modules' => array(
        'Core',
      )
    );

The first option, `path`, is the absolute path to the app-directory of your
application. It is set automatically using the `__FILE__` constant, and this
should be fine for most applicaitons. `name` and `version` are the name and version
of your application. `modules` is an array
of modules that your application needs.

Next we need an entry-script to run our application. In an optimal setup this
file should be the only file accessible from the outside. We'll call it
`index.php` and put it next to our app-directory.

    <?php
    // index.php
    require_once 'lib/Core/bootstrap.php';

    Lib::import('Core');

    $app = new App(include 'app/app.php', basename(__FILE__));

    $environment = getenv('MYAPP_ENVIRONMENT');
    $environment || $environment = 'production';

    $app->run($environment);


## Skeleton

- index.php
- app/
  - app.php
  - assets/
  - config/
    - environments/
  - controllers/
  - helpers/
  - log/
  - models/
  - schemas/
  - templates/
- lib/
  - Core/

## Hello, World!

### Configuration

Create the `config` directory in your app-directory. This will hold the
configuration files for the application. Create an empty file called
`config.php` in the config-directory. Change the permissions of the file so that
PHP can write to it. chmod 0664.

Create another directory, called `environments`, in your config-directory. In
this new directory create two PHP-files, `production.php` and `development.php`:

    <?php
    // app/config/environments/production.php
    return array(
      'core' => array(
        'showExceptions' => false,
        'logLevel' => Logger::ERROR,
        'createCrashReports' => true,
      ),
    );

The first one, `production.php`, configures the web application for production
mode, this means that exceptions won't be printed to the screen, and only
messages of type `Logger::ERROR` will be logged.

    <?php
    // app/config/environments/development.php
    ini_set('display_errors', true);
    return array(
      'core' => array(
        'showExceptions' => true,
        'logLevel' => Logger::ALL,
        'createCrashReports' => false,
      ),
    );
    
This one configures the application for development mode. The call to `ini_set()`
makes PHP display fatal errors. This environment should be used when you develop
your application.

### Running the application

Point your browser at `index.php`.

Use `php -S localhost:2000 index.php` in the directory that contains `index.php`, to
start PHP's built-in web server, and access it by going to
http://localhost:2000/index.php .

The first time you run the application, you are required to provide the
information necessary to connect to the database. The first screen will allow
you to select the database driver. Depending on which PHP extensions you have
installed, some options may not be available.

If you don't have a MySQL server ready, SQLite may be the easiest option for
now. Select either "Sqlite3" or "Sqlite (PDO)" if available. If PHP doesn't have
write access to the `config.php`-file, you'll be met with a page telling you
that the configuration could not be saved. If not you'll have to select the
location of the SQLite database. The default location is a `db.sqlite3` file in
your config-directory, and this should be fine. Again you should create this
file (empty) and give PHP permission to write to it before continuing.

The last setup page, gives you the option to create an admin-user in the
authentication module.

When setup is done you should see either a white page with the text

> An error occured while loading this page...

or an "Uncaught exception" page telling you that no route was selected.

If you see the white page, the application is running in production-mode and
won't spit out any useful error information (this information is available in
the `production.log`-file and the generated crash report). When developing your
application you probably want to be running in development mode. To switch to
development mode, either set the environmental variable `MYAPP_ENVIRONMENT` to
`development`, or change the last line of your `index.php`:

    // $app->run($environment);
    $app->run('development');

### Creating a controller

Creating the application controller:

    <?php
    // app/controllers/AppController.php
    class AppController extends Controller {
      public function index() {
        $this->render();
      }
      public function notFound() {
        $this->render();
      }
    }

### Creating a route

Create the file `routes.php` in your config-directory:

    <?php
    // app/config/routes.php
    return array(
      Route::root('App::index'),
      Route::error('App::notFound'),
    );

## Posts

### The model and schema

    <?php
    // app/models/Post.php
    class Post extends ActiveRecord {
    }

And schema:

    <?php
    // app/schemas/postsSchema.php
    class postsSchema extends Schema {
      protected function createSchema() {
        $this->addInteger('id', Schema::AUTO_INCREMENT | Schema::NOT_NULL | Schema::UNSIGNED);
        $this->addString('title', 255, Schema::NOT_NULL);
        $this->addText('content', Schema::NOT_NULL);
        $this->addInteger('created_at', Schema::NOT_NULL | Schema::UNSIGNED);

        $this->setPrimaryKey('id');
        $this->addIndex('created_at', 'created_at');
      }
    }

### The controller

    <?php
    // app/controllers/PostsController.php
    class PostsController extends AppController {

      // Models used by this controller
      protected $models = array('Post');

      // Helpers used by this controller
      protected $helpers = array('Html', 'Form');

      // Index action: View all posts
      public function index() {
        $this->posts = $this->Post->all();
        $this->render();
      }

      // View action: View a single post
      public function view($postId) {
        $this->post = $this->Post->find($postId);
        $this->render();
      }

      // Add action: Create a new post
      public function add() {
        if ($this->request->hasValidData()) {
          $this->post = $this->Post->create($this->request->data['post']);
          $this->post->created_at = time();
          if ($this->post->save()) {
            $this->session->notice('Post saved');
            $this->refresh();
          }
        }
        else {
          $this->post = $this->Post->create();
        }
        $this->render();
      }
    }

### The view

`index` template:

    <?php
    // app/templates/posts/index.html.php
    $this->extend('layout.html');
    ?>
    <h2>Posts</h2>
    <ul>
    <?php foreach ($posts as $post): ?>

    <li><?php echo $Html->link($post->title, $post); ?></li>

    <?php endforeach; ?>
    </ul>

`view` template:

    <?php
    // app/templates/posts/view.html.php
    $this->extend('layout.html');
    ?>
    <h2><?php echo $post->title; ?></h2>

    <?php echo $post->content; ?>

`add` template:

    <?php
    // app/templates/posts/add.html.php
    $this->extend('layout.html');
    ?>
    <h2>Add post</h2>

    <?php echo $Form->begin($post); ?>

    <p>
    <?php echo $Form->label('title'); ?>
    <?php echo $Form->field('title'); ?>
    </p>

    <p>
    <?php echo $Form->label('content'); ?>
    <?php echo $Form->field('content'); ?>
    </p>

    <p>
    <?php echo $Form->submit('Add'); ?>
    </p>

    <?php echo $Form->end(); ?>

the layout:

    <?php
    // app/templates/layout.html.php
    ?>
    <!DOCTYPE html>
    <head>
    <title>My Web App</title>
    </head>
    <body>
    <h1>My Web App</h1>
    <p>
    <?php echo $Html->link('Home'); ?> |
    <?php echo $Html->link('Add post', 'Posts::add'); ?>
    </p>

    <?php echo $this->block('content'); ?>

    </body>
    </html>
### Routing

    <?php
    // app/config/routes.php
    return array(
      Route::root('Posts::index'),
      Route::error('App::notFound'),
      Route::auto('Posts::add'),
      Route::match('posts/:1', 'Posts::view'),
    );
</xmp>

<script src="http://strapdownjs.com/v/0.2/strapdown.js"></script>
</html>
